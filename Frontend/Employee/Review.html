<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Review Management</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" defer></script>

  <style>
    :root{--brand:#0d6efd;--muted:#6c757d;--card-radius:14px}
    html,body{height:100%}
    body{background:linear-gradient(180deg,#f7fbff 0%,#ffffff 70%);font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial;color:#0f1724}

    /* Navbar */
    .navbar{background:transparent}
    .brand-bubble{width:46px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--brand),#6fa8ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}

    /* layout */
    .sidebar{min-width:220px;max-width:260px;padding:1rem;border-radius:var(--card-radius);background:linear-gradient(180deg,rgba(13,110,253,0.04),rgba(13,110,253,0.02));height:100%}
    .sidebar .nav-link{color:var(--muted)}
    .sidebar .nav-link.active{color:var(--brand);font-weight:600}

    .card-rounded{border-radius:var(--card-radius);box-shadow:0 8px 30px rgba(16,24,40,0.04)}
    .stat-card{border-radius:12px;padding:1rem}

    /* table */
    .table thead th{border-bottom:0;color:#556070}
    .table tbody tr{background:#fff;border-radius:10px;margin-bottom:12px;box-shadow:0 6px 18px rgba(12,23,40,0.03)}
    .table{border-collapse:separate;border-spacing:0 12px}
    .table td,.table th{vertical-align:middle;border:0;padding:1rem}
    /* avatar */
    .avatar {
      width: 46px; height: 46px; border-radius: 12px; font-size: 1.1rem; font-weight:700;
      color:#fff; display:flex; align-items:center; justify-content:center;
      background: linear-gradient(135deg,var(--brand),#6fa8ff);
    }

    .muted { color: var(--muted); }
    .small-input { height: 32px; padding: 4px 8px; }

    /* table */
    .table { border-collapse: separate; border-spacing: 0 12px; }
    .table tbody tr { background: #fff; border-radius: 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.04); }
    .table td, .table th { border: none; padding: 14px; vertical-align: middle; }

    /* nav links */
    .nav-link { padding: .6rem .75rem; border-radius: 8px; color: #333; font-weight: 500; }
    .nav-link.active { background: rgba(13,110,253,.1); color: var(--brand); font-weight: 600; }
    .nav-link:hover { background: rgba(13,110,253,.08); }

    /* badges */
    .badge-overdue { background: #f8d7da; color: #7a1a1a; padding: .4rem .65rem; border-radius: 6px; }
    .badge-upcoming { background: #fff4e5; color: #664d03; padding: .4rem .65rem; border-radius: 6px; }

    /* review rules inside sidebar */
    .review-rules .fw-bold { font-size: 1rem; }
    .review-rules .muted { line-height: 1.5; }

    /* responsive */
    @media (max-width: 991px) {
      .container-fluid { padding-left: 1rem; padding-right: 1rem; }
      .sidebar { min-height: auto; }
    }
  </style>
</head>
<body>

  <!-- NAV -->
  <nav class="navbar navbar-expand-lg mb-4 px-4">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-3">
        <!-- mobile sidebar toggle -->
        <button class="btn btn-outline-secondary d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar" aria-controls="mobileSidebar">
          <i class="bi bi-list"></i>
        </button>

        <a class="navbar-brand d-flex align-items-center gap-3" href="#">
          <div class="brand-bubble">CO</div>
          <div>
            <div class="fw-bold">Client Onboarding</div>
            <small class="muted">Employee Portal</small>
          </div>
        </a>
      </div>

      <div class="d-flex align-items-center ms-auto gap-3">
        <div class="text-end d-none d-md-block">
          <div id="userEmail" class="fw-semibold">user@example.com</div>
          <small class="muted" id="userRole">Employee</small>
        </div>
        <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
      </div>
    </div>
  </nav>

  <!-- mobile offcanvas sidebar -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar" aria-labelledby="mobileSidebarLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mobileSidebarLabel">Menu</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <aside class="p-0">
        <div class="d-flex align-items-center mb-3 gap-3">
          <div class="avatar">S</div>
          <div>
            <div id="userName1" class="fw-bold"></div>
            <small class="muted">Product & Support</small>
          </div>
        </div>

        <nav class="nav flex-column mb-3">
          <a class="nav-link " href="Dashboard.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
          <a class="nav-link" href="Review.html"><i class="bi bi-gear me-2"></i>Review</a>
          <a class="nav-link" href="Statistics.html"><i class="bi bi-graph-up me-2"></i>Statistics</a>
        </nav>

        <hr />

        <div>
          <small class="text-uppercase muted">Quick filters</small>
          <div class="d-flex flex-column gap-2 mt-2">
            <button class="btn btn-sm btn-outline-primary text-start">All Customers</button>
            <button class="btn btn-sm btn-outline-success text-start">Approved <span class="badge bg-success ms-2">142</span></button>
            <button class="btn btn-sm btn-outline-warning text-start">Pending <span class="badge bg-warning text-dark ms-2">18</span></button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- MAIN LAYOUT -->
  <div class="container-fluid">
    <div class="row g-4">
      <!-- SIDEBAR (desktop) -->
      <div class="col-12 col-lg-3 d-none d-lg-block">
        <aside class="sidebar card-rounded p-3 shadow-sm">
          <div class="d-flex align-items-center mb-3 gap-3">
            <div class="avatar">S</div>
            <div>
              <div id="userName" class="fw-bold">EM</div>
              <small class="muted">Product & Support</small>
            </div>
          </div>

          <nav class="nav flex-column mb-3">
            <a class="nav-link " href="Dashboard.html"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
            <a class="nav-link active" href="Review.html"><i class="bi bi-gear me-2"></i>Review</a>
            <a class="nav-link" href="Statistics.html"><i class="bi bi-graph-up me-2"></i>Statistics</a>
          </nav>

          <hr />

          <!-- REVIEW RULES (inside sidebar) -->
          <div class="review-rules mt-3">
            <div class="fw-bold mb-2">Review Rules</div>
            <div class="muted small mb-2">
              • Default frequency: 6 months<br />
              • Auto-schedule on approval<br />
              • Manual override allowed
            </div>
            <div>
              <button class="btn btn-sm btn-primary w-100" id="btnScheduler">Run Scheduler (dev)</button>
            </div>
          </div>

          <div class="d-flex flex-column gap-2 mt-3">
            <!-- additional sidebar items here -->
          </div>
        </aside>
      </div>

      <!-- MAIN CONTENT -->
      <div class="col-12 col-lg-9">
        <!-- top header card -->
        <div class="card p-3 card-rounded mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">Reviews</h5>
              <small class="muted">Upcoming and overdue reviews</small>
            </div>
            <div>
              <div class="btn-group" role="group">
               <button id="btnUpcoming" class="btn btn-outline-primary" >
  Upcoming
</button>

<button id="btnOverdue" class="btn btn-outline-secondary">
  Overdue
</button>

              </div>
            </div>
          </div>
        </div>

        <!-- filters + table card -->
        <div class="card card-rounded p-0">
          <div class="p-3 border-bottom d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="fw-bold d-flex align-items-center gap-3">
              <div id="tableTitle">Upcoming Reviews</div>
              <small class="muted" id="reviewCount" aria-live="polite">0</small>
            </div>

            <div class="muted small d-flex align-items-center gap-2">
              <label class="mb-0 small">From</label>
              <input type="date" id="filterFrom" class="form-control form-control-sm small-input" />
              <label class="mb-0 small">To</label>
              <input type="date" id="filterTo" class="form-control form-control-sm small-input" />
              <select id="presetDays" class="form-select form-select-sm" style="width:120px">
                <option value="">Preset</option>
                <option value="7">Next 7d</option>
                <option value="30">Next 30d</option>
                <option value="365" selected>Next 365d</option>
              </select>
              <button id="applyFilterBtn" class="btn btn-sm btn-primary">Apply</button>
              <div id="loadingSpinner" class="spinner-border spinner-border-sm text-primary ms-2 d-none" role="status"></div>
            </div>
          </div>

          <div class="table-responsive p-3">
            <table class="table" id="reviewsTable">
              <thead>
                <tr class="muted small">
                  <th>Customer Name</th>
                  <th>Last Review</th>
                  <th>Next Review</th>
                  <th>Days</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="reviewsTbody"></tbody>
            </table>
          </div>
        </div>
      </div> <!-- /.col main -->
    </div> <!-- /.row -->
  </div> <!-- /.container-fluid -->

  <!-- Complete Review Modal -->
  <div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Complete Review</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="completeForm">
            <input type="hidden" id="completeReviewId" />
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Review Date</label>
                <input type="date" id="reviewDate" class="form-control" />
              </div>
              <div class="col-md-6">
                <label class="form-label">Next Review Date</label>
                <input type="date" id="nextReviewDate" class="form-control" />
              </div>
              <div class="col-12">
                <label class="form-label">Notes</label>
                <textarea id="reviewNotes" class="form-control" rows="4" placeholder="Optional notes..."></textarea>
              </div>
            </div>
          </form>
          <div id="completeError" class="text-danger mt-2 d-none"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" id="confirmCompleteBtn">Complete & Schedule Next</button>
        </div>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const API_BASE = '';
  const TOKEN_KEY = 'token';
  const SESSION_KEY = 'loginTime';
  const MAX_SESSION_DURATION = 30 * 60 * 1000; // 30 min

  // DOM elements
  const reviewsTbody = document.getElementById('reviewsTbody');
  const tableTitle = document.getElementById('tableTitle');
  const applyFilterBtn = document.getElementById('applyFilterBtn');
  const filterFrom = document.getElementById('filterFrom');
  const filterTo = document.getElementById('filterTo');
  const presetDays = document.getElementById('presetDays');
  const loadingSpinner = document.getElementById('loadingSpinner');
  const userNameEl = document.getElementById("userName");
  const userNameE2 = document.getElementById("userName1");
  const userEmailEl = document.getElementById('userEmail');
  const logoutBtn = document.getElementById('logoutBtn');
  const btnUpcoming = document.getElementById('btnUpcoming');
  const btnOverdue = document.getElementById('btnOverdue');
  const btnScheduler = document.getElementById('btnScheduler');
  const confirmCompleteBtn = document.getElementById('confirmCompleteBtn');
  const reviewCountEl = document.getElementById('reviewCount');

  let currentTab = 'upcoming';
  let currentList = [];

  function getToken(){ return localStorage.getItem(TOKEN_KEY); }

  // Safe parse token payload (returns null if not available or invalid)
  function safeParseTokenPayload() {
    const token = getToken();
    if (!token) return null;
    try {
      const parts = token.split('.');
      if (parts.length < 2) return null;
      const payloadJson = atob(parts[1].replace(/-/g, '+').replace(/_/g, '/'));
      return JSON.parse(payloadJson);
    } catch (e) {
      console.warn('Failed to parse token payload', e);
      return null;
    }
  }

  // Generic API fetch that enforces session and auth header
  async function apiFetch(endpoint, options = {}) {
    const token = getToken();
    const loginTime = localStorage.getItem(SESSION_KEY);

    if (!token || !loginTime || (Date.now() - loginTime > MAX_SESSION_DURATION)) {
      // session missing/expired
      alert('Session expired. Please log in again.');
      // clear session data and redirect to login
      localStorage.removeItem(TOKEN_KEY);
      localStorage.removeItem(SESSION_KEY);
      window.location.href = 'login.html';
      return;
    }
    // refresh session timestamp
    localStorage.setItem(SESSION_KEY, Date.now());

    const headers = {
      'Content-Type': 'application/json',
      ...(options.headers || {})
    };
    if (token) headers['Authorization'] = 'Bearer ' + token;

    const res = await fetch(`${API_BASE}${endpoint}`, {
      ...options,
      headers
    });

    if (!res.ok) {
      // try to parse json error
      const text = await res.text().catch(()=>null);
      let parsed;
      try { parsed = JSON.parse(text); } catch(e){ parsed = null; }
      const errMsg = (parsed && parsed.message) ? parsed.message : text || 'API request failed';
      const err = new Error(errMsg);
      err.status = res.status;
      throw err;
    }
    // if no content
    if (res.status === 204) return null;
    return res.json().catch(()=>null);
  }

  /* ========= Logout ========= */
  function logout() {
    localStorage.removeItem(TOKEN_KEY);
    localStorage.removeItem(SESSION_KEY);
    localStorage.removeItem('userId');
    window.location.href = 'login.html';
  }
  logoutBtn && logoutBtn.addEventListener('click', logout);

  // Fill user info if token present
  const payload = safeParseTokenPayload();
  if (payload && payload.email) {
    userEmailEl.textContent = payload.email;
    const username = payload.email.split('@')[0];
    userNameEl.textContent = username;
    userNameE2.textContent = username;
  } else {
    // fallback if not logged in: keep default UI but don't crash
    userEmailEl.textContent = 'user@example.com';
  }

  function onPresetChange(){
    const days = presetDays.value;
    if (!days) return;
    const now = new Date();
    const todayUtc = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    const toUtc = new Date(todayUtc.getTime() + parseInt(days,10) * 24 * 60 * 60 * 1000);
    filterFrom.value = todayUtc.toISOString().slice(0,10);
    filterTo.value = toUtc.toISOString().slice(0,10);
  }

  // parse YYYY-MM-DD as UTC midnight (no local timezone shift)
  function parseISODateAsUTC(isoDate) {
    if (!isoDate) return null;
    return new Date(isoDate + 'T00:00:00Z');
  }

  // returns integer days difference (target - today), using UTC midnights
  function daysDiffFromToday(iso) {
    const d = parseISODateAsUTC(iso);
    if (!d) return NaN;
    const now = new Date();
    const todayUtc = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate()));
    const msPerDay = 24 * 60 * 60 * 1000;
    return Math.round((d - todayUtc) / msPerDay);
  }

  function createBadge(days) {
    const span = document.createElement('span');
    if (Number.isNaN(days)) {
      span.className = 'muted';
      span.textContent = '-';
    } else if (days < 0) {
      span.className = 'badge-overdue';
      span.textContent = Math.abs(days) + 'd';
    } else {
      span.className = 'badge-upcoming';
      span.textContent = days + 'd';
    }
    return span;
  }

  // Render a single row safely (no innerHTML with DB data)
  function renderRow(r){
    const tr = document.createElement('tr');
    const days = daysDiffFromToday(r.scheduled_date || r.next_review_date);
    const firstName = r.customer && r.customer.first_name ? r.customer.first_name : '';
    const lastName = r.customer && r.customer.last_name ? r.customer.last_name : '';
    const custName = (firstName || lastName) ? `${firstName} ${lastName}`.trim() : (r.customer_name || r.customer_id || 'N/A');

    // columns
    const tdName = document.createElement('td');
    tdName.textContent = custName;

    const tdLast = document.createElement('td');
    tdLast.textContent = r.completed_date || r.last_review_date || '-';

    const tdNext = document.createElement('td');
    tdNext.textContent = r.scheduled_date || r.next_review_date || '-';

    const tdDays = document.createElement('td');
    tdDays.appendChild(createBadge(days));

    const tdActions = document.createElement('td');
    tdActions.className = 'text-end';
    const btn = document.createElement('button');
    btn.className = 'btn btn-sm btn-success complete-review';
    btn.type = 'button';
    btn.dataset.reviewId = r.id;
    btn.textContent = 'Complete';
    tdActions.appendChild(btn);

    tr.appendChild(tdName);
    tr.appendChild(tdLast);
    tr.appendChild(tdNext);
    tr.appendChild(tdDays);
    tr.appendChild(tdActions);

    return tr;
  }

  function renderList(list){
    reviewsTbody.innerHTML = '';
    if (!list || list.length === 0) {
      reviewsTbody.innerHTML = '<tr><td colspan="5">No reviews found.</td></tr>';
      if (reviewCountEl) reviewCountEl.textContent = '0';
      currentList = [];
      return;
    }
    list.forEach(r => reviewsTbody.appendChild(renderRow(r)));
    if (reviewCountEl) reviewCountEl.textContent = String(list.length);
    currentList = list;
    // attach handlers
    document.querySelectorAll('.complete-review').forEach(b => {
      b.removeEventListener('click', completeHandler); // safe removal if previously attached
      b.addEventListener('click', completeHandler);
    });
  }

  // detachable handler so we can remove it if needed
  function completeHandler(e) {
    const id = e.currentTarget.dataset.reviewId;
    openCompleteModal(id);
  }

  // Helper: builds query params for upcoming endpoint
  function buildParamsFromFilters() {
    const params = new URLSearchParams();
    if (filterFrom.value) params.set('from', filterFrom.value);
    if (filterTo.value) params.set('to', filterTo.value);
    return params.toString();
  }

  async function loadTab(tab, useFilters = false) {
    currentTab = tab;

    // Update title and active button UI
    tableTitle.textContent = tab === 'upcoming' ? 'Upcoming Reviews' : 'Overdue Reviews';

    btnUpcoming.classList.toggle('active', tab === 'upcoming');
    btnOverdue.classList.toggle('active', tab === 'overdue');

    applyFilterBtn.disabled = true;
    loadingSpinner.classList.remove('d-none');

    try {
      let endpoint;
      let query = '';
      if (tab === 'upcoming') {
        endpoint = '/api/reviews/upcoming';
        if (useFilters) query = buildParamsFromFilters();
      } else {
        endpoint = '/api/reviews/overdue';
        if (useFilters) query = buildParamsFromFilters();
      }
      const full = query ? `${endpoint}?${query}` : endpoint;
      const json = await apiFetch(full, { method: 'GET' });
      const reviews = (json && json.reviews) ? json.reviews : (Array.isArray(json) ? json : []);
      renderList(reviews);
    } catch (e) {
      console.error('loadTab error', e);
      reviewsTbody.innerHTML = '<tr><td colspan="5">Failed to load reviews.</td></tr>';
      if (reviewCountEl) reviewCountEl.textContent = '0';
    } finally {
      applyFilterBtn.disabled = false;
      loadingSpinner.classList.add('d-none');
    }
  }

  async function loadOverdueReviews() {
    // convenience wrapper
    await loadTab('overdue', true);
  }

  async function openCompleteModal(reviewId){
    document.getElementById('completeReviewId').value = reviewId;

    const review = currentList.find(r => String(r.id) === String(reviewId));
    // If review not found locally, still allow modal with minimal data
    const todayIso = new Date().toISOString().slice(0,10);
    document.getElementById('reviewDate').value = todayIso;
    document.getElementById('nextReviewDate').value = addMonthsISO(todayIso, 6);
    document.getElementById('reviewNotes').value = review && review.notes ? review.notes : '';

    // clear any previous customer/past containers
    const existingCustomerInfo = document.getElementById('customerInfo');
    if (existingCustomerInfo) existingCustomerInfo.remove();
    const existingPastNotes = document.getElementById('pastNotes');
    if (existingPastNotes) existingPastNotes.remove();

    // try fetch customer & past reviews if we have customer_id
    const token = getToken();
    if (review && review.customer_id) {
      try {
        const customer = await apiFetch(`/api/customers/${encodeURIComponent(review.customer_id)}`, { method: 'GET' });
        if (customer) populateCustomerInfo(customer);
      } catch (err) {
        console.warn('Failed to fetch customer info', err);
      }

      try {
        const pastData = await apiFetch(`/api/reviews/customer/${encodeURIComponent(review.customer_id)}`, { method: 'GET' });
        const pastReviews = (pastData && pastData.pastReviews) ? pastData.pastReviews : (Array.isArray(pastData) ? pastData : []);
        populatePastNotes(pastReviews);
      } catch (err) {
        console.warn('Failed to fetch past reviews', err);
      }
    }

    // Show modal
    new bootstrap.Modal(document.getElementById('completeModal')).show();
  }

  function populatePastNotes(reviews) {
    let container = document.getElementById('pastNotes');
    if (!container) {
      container = document.createElement('div');
      container.id = 'pastNotes';
      container.className = 'mb-3 p-2 border rounded';
      document.querySelector('#completeModal .modal-body').append(container);
    }

    if (!Array.isArray(reviews) || reviews.length === 0) {
      container.innerHTML = '<p class="muted">No past notes available.</p>';
      return;
    }

    let html = '<h6>Past Notes</h6>';
    html += '<ul class="list-group">';
    reviews.forEach(r => {
      const date = r.completed_date || r.scheduled_date || '-';
      const notes = (r.notes) ? String(r.notes) : '-';
      html += `<li class="list-group-item"><strong>${date}:</strong> ${notes}</li>`;
    });
    html += '</ul>';
    container.innerHTML = html;
  }

  function populateCustomerInfo(customer) {
    let container = document.getElementById('customerInfo');
    if (!container) {
      container = document.createElement('div');
      container.id = 'customerInfo';
      container.className = 'mb-3 p-2 border rounded';
      document.querySelector('#completeModal .modal-body').prepend(container);
    }

    // guard against missing fields
    const name = customer.customerName || [customer.first_name, customer.last_name].filter(Boolean).join(' ') || customer.email || '-';
    container.innerHTML = `
      <h6>Customer Info</h6>
      <p><strong>Name:</strong> ${name}</p>
      <p><strong>Email:</strong> ${customer.email || '-'}</p>
      <p><strong>Status:</strong> ${customer.status || '-'}</p>
      <p><strong>Phone:</strong> ${customer.phone || '-'}</p>
      <p><strong>Address:</strong> ${customer.address_line1 || '-'}, ${customer.city || '-'}, ${customer.postal_code || '-'}, ${customer.country || '-'}</p>
      <p><strong>Annual Income:</strong> ${customer.annual_income ?? '-'}</p>
      <p><strong>Account Type:</strong> ${customer.account_type || '-'}</p>
      <p><strong>Risk Score:</strong> ${customer.risk_score ?? '-'} (${customer.risk_level ?? '-'})</p>
    `;
  }

  // safer addMonthsISO handling month overflow, retaining UTC behavior
  function addMonthsISO(isoDate, months) {
    const [y, m, d] = isoDate.split('-').map(Number);
    const date = new Date(Date.UTC(y, m - 1, d));
    const targetMonthStart = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth() + months, 1));
    const lastDay = new Date(Date.UTC(targetMonthStart.getUTCFullYear(), targetMonthStart.getUTCMonth() + 1, 0)).getUTCDate();
    const day = Math.min(d, lastDay);
    targetMonthStart.setUTCDate(day);
    return targetMonthStart.toISOString().slice(0,10);
  }

  async function confirmComplete(){
    const btn = document.getElementById('confirmCompleteBtn');
    btn.disabled = true;
    const errEl = document.getElementById('completeError');

    const reviewId = document.getElementById('completeReviewId').value;
    const completedDate = document.getElementById('reviewDate').value;
    const nextReviewDate = document.getElementById('nextReviewDate').value;
    const notes = document.getElementById('reviewNotes').value.trim();

    // clear error
    if (errEl) { errEl.classList.add('d-none'); errEl.textContent = ''; }

    // basic client validation
    if (!completedDate) {
      if (errEl) { errEl.textContent = 'Please select a review date.'; errEl.classList.remove('d-none'); }
      btn.disabled = false;
      return;
    }
    if (nextReviewDate && (new Date(nextReviewDate) < new Date(completedDate))) {
      if (errEl) { errEl.textContent = 'Next review date must be after or equal to review date.'; errEl.classList.remove('d-none'); }
      btn.disabled = false;
      return;
    }

    try {
      const payload = { completedDate, notes, nextReviewDate };
      await apiFetch(`/api/reviews/${encodeURIComponent(reviewId)}/complete`, {
        method: 'PUT',
        body: JSON.stringify(payload)
      });
      // success: close modal & reload current view (respect filters if set)
      const modalEl = document.getElementById('completeModal');
      const modalInstance = bootstrap.Modal.getInstance(modalEl);
      modalInstance && modalInstance.hide();
      await loadTab(currentTab, Boolean(filterFrom.value || filterTo.value));
    } catch (e) {
      console.error('confirmComplete error', e);
      if (errEl) { errEl.textContent = e.message || 'Failed to complete review.'; errEl.classList.remove('d-none'); }
    } finally {
      btn.disabled = false;
    }
  }

  async function runScheduler(){
    const btn = btnScheduler;
    btn.disabled = true;
    try {
      const json = await apiFetch('/api/reviews/admin/run-review-scheduler', {
        method: 'POST',
      });
      const createdCount = Array.isArray(json && json.created) ? json.created.length : (json && json.created ? 1 : 0);
      alert('Scheduler created ' + createdCount + ' reviews');
      // reload current view
      await loadTab(currentTab, Boolean(filterFrom.value || filterTo.value));
    } catch (err) {
      console.error('runScheduler', err);
      alert('Scheduler run failed: ' + (err.message || 'unknown error'));
    } finally {
      btn.disabled = false;
    }
  }

  // Hook up UI events
  btnUpcoming && btnUpcoming.addEventListener('click', () => loadTab('upcoming', true));
  btnOverdue && btnOverdue.addEventListener('click', () => loadTab('overdue', true));
  applyFilterBtn && applyFilterBtn.addEventListener('click', ()=>loadTab(currentTab, true));
  presetDays && presetDays.addEventListener('change', onPresetChange);
  btnScheduler && btnScheduler.addEventListener('click', runScheduler);
  confirmCompleteBtn && confirmCompleteBtn.addEventListener('click', confirmComplete);
  // --- backfill once per session when the page loads ---
  async function runBackfillOncePerSession() {
    try {
      // don't run more than once per browser session
      if (sessionStorage.getItem('backfillDone')) return;

      // show spinner while backfill runs (optional)
      if (loadingSpinner) loadingSpinner.classList.remove('d-none');

      // call your backfill endpoint — adjust path if your route is mounted differently
      // NOTE: apiFetch expects a path relative to API_BASE (it will call `${API_BASE}${endpoint}`)
      const json = await apiFetch('/api/reviews/backfill', { method: 'POST' });

      // mark as done for this browser session
      sessionStorage.setItem('backfillDone', '1');

      // user feedback (replace with toast if you prefer)
      if (json && json.message) {
        console.info('Backfill:', json.message);
      } else {
        console.info('Backfill completed');
      }
    } catch (err) {
      // do not block the UI if backfill fails — log and optionally show a non-blocking message
      console.warn('Backfill failed:', err);
      // if you want the user to know: uncomment the next line
      // alert('Backfill failed: ' + (err && err.message ? err.message : 'unknown error'));
    } finally {
      if (loadingSpinner) loadingSpinner.classList.add('d-none');
    }
  }


  runBackfillOncePerSession().finally(() => {
    onPresetChange();
    loadTab('upcoming', true);
  });

});
</script>
</body>
</html>
